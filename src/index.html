<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Qualifica Web</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/#[[latestVersion]]#/mdb.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css" />
  <style>
    INPUT:-webkit-autofill,
    SELECT:-webkit-autofill,
    TEXTAREA:-webkit-autofill {
      animation-name: onautofillstart
    }

    INPUT:not(:-webkit-autofill),
    SELECT:not(:-webkit-autofill),
    TEXTAREA:not(:-webkit-autofill) {
      animation-name: onautofillcancel
    }

    @keyframes onautofillstart {
      from {}
    }

    @keyframes onautofillcancel {
      from {}
    }
  </style>
  <style>
    .page-intro {
      background-color: white;
      width: 100vw;
      min-height: 100vh;
    }

    img {
      max-width: 80%;
    }

    .mdb-page-content {
      padding-left: 240px;
      transition: padding 0.3s linear;
    }

    #toggler {
      display: none;
    }

    @media (max-width: 660px) {
      .mdb-page-content {
        padding-left: 0px;
      }

      #toggler {
        display: unset;
      }

      .mask img {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-mdb-toggle="collapse" data-mdb-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button>
      <button id="toggler" class="btn btn-dark mt-5 ripple-surface" data-toggle="sidenav" data-target="#full-screen-example" aria-expanded="true">
          <i class="fas fa-bars"></i>
        </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="loadScreen('frequencia')">FrequÃªncia</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="loadScreen('certificado')">Certificado</a>

            <script>
              function loadCertificado() {
                google.script.run.withSuccessHandler(function(page) {
                  var newWindow = window.open("", "_blank");
                  var htmlString = page;
                  newWindow.document.write(htmlString);
                  newWindow.document.title = "Certificado";
                }).getCertificado();
              }
            </script>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Pagamento</a>
          </li>
        </ul>
      </div>
      <div class="d-flex align-items-center">
        <div class="mx-2">
          <select class="custom-select custom-select-md" id="selectAno">
            <option selected value="">Ano</option>
          </select>
        </div>
        <div class="mx-2">
          <select class="custom-select custom-select-md " id="selectPrograma">
            <option selected value="">Programa</option>
          </select>
        </div>
        <div class="mx-2">
          <select class="custom-select custom-select-md" id="selectTurma">
            <option selected value="">Turma</option>
          </select>
        </div>
        <div class="dropdown">

          <script>
            try{
              google.script.run.withSuccessHandler((data)=>{
                 document.getElementById('profile-picture').src =  data.foto;
                 document.getElementById("profile-name").textContent=data.nome
              }).getUserInfo();
            }catch(ex){
              console.error(ex)
            }
          </script>
          <a class="dropdown-toggle d-flex align-items-center hidden-arrow" href="#" id="navbarDropdownMenuAvatar"
            role="button" data-mdb-toggle="dropdown" aria-expanded="false">
            <img
              id="profile-picture"
              class="rounded-circle"
              height="35"
              loading="lazy"
            />
            <span id="profile-name"></span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuAvatar">
            <li>
              <!--Logout script-->
              <script type="module">
                import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
                function logout() {
                  localStorage.removeItem('token');
                  signOut(getAuth())
                    .then(() => {
                      google.script.run
                        .withSuccessHandler((page) => {
                          document.open();
                          document.write(page);
                          document.close();
                        })
                        .include('login')
                    })
                    .catch((error) => {
                      console.error(error);
                    });
                }
                const logoutButton = document.getElementById('logout-button');
                logoutButton.addEventListener('click', logout);
              </script>
              <a class="dropdown-item" id="logout-button" href="#">Sair</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>
  <div id="content">
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.2.0/mdb.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js"
    integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"></script>
  <script>
    var icon = {
      info:'info',
      warning:'warning',
      error:'error',
      success:'success'
    }
    function toast(title,text,icon){
      $.toast({
        text: text,
        heading: title,
        icon: icon, 
        showHideTransition: 'fade',
        allowToastClose: true, 
        hideAfter: 3000, 
        stack: 100, 
        position: 'top-right',
        textAlign: 'left',
        loader: true,
        loaderBg: '#FFFFFF',
        /*beforeShow: function () {}, // will be triggered before the toast is shown
        afterShown: function () {}, // will be triggered after the toat has been shown
        beforeHide: function () {}, // will be triggered before the toast gets hidden
        afterHidden: function () {}  // will be triggered after the toast has been hidden */
      }); 
    }
    function setInnerHTML(elm, html) {
      elm.innerHTML = html;
      Array.from(elm.querySelectorAll("script"))
        .forEach( oldScriptEl => {
          const newScriptEl = document.createElement("script");
          Array.from(oldScriptEl.attributes).forEach( attr => {
            newScriptEl.setAttribute(attr.name, attr.value) 
          });
          const scriptText = document.createTextNode(oldScriptEl.innerHTML);
          newScriptEl.appendChild(scriptText);
          oldScriptEl.parentNode.replaceChild(newScriptEl, oldScriptEl);
        });
    }
    function loadScreen(name) {
      $.LoadingOverlay("show");
      google.script.run
        .withSuccessHandler(function(page) {
          try{
            var htmlString = page;
            setInnerHTML( document.getElementById('content'),page)
            if(name=='frequencia'){
              getFrequencia($("#selectAno").val(),$("#selectPrograma").val(),$("#selectTurma").val());
            }
          }
          catch(ex){
            console.error(ex)
            document.getElementById('content').innerHTML=''
          }
          finally{
            $.LoadingOverlay("hide");
          }
        })
        .withFailureHandler((ex)=>{
          $.LoadingOverlay("hide");
          console.error(ex)
          toast('Erro','Ocorreu um problema ao carregar a tela.',icon.error)
        })
        .include(name);
    }
    function getAllAnos() {
      $.LoadingOverlay("show")
      const select = $("#selectAno");
      select.empty(); 
      google.script.run
        .withSuccessHandler((lista) => {
          try{
            select.append($("<option>").text('Ano').prop('readonly', true).prop('hidden', true).prop('selected', true).val(''));
            lista.forEach((opt) => {
              const el = $("<option>").text(opt).val(opt);
              select.append(el);
            });
            if(lista.length==1){
              $("#selectAno").val(lista[0])
              getAllProgramas($("#selectAno").val())
            }
            select.change(() => {
              const selectedAno = select.val()
              getAllProgramas(selectedAno)
            });
          }
          catch(ex){
            toast('Erro','Ocorreu um problema ao carregar os dados.',icon.error)
            console.error(ex)
          }
          finally{
            $.LoadingOverlay("hide")
          }
        })
        .withFailureHandler((ex)=>{
          $.LoadingOverlay("hide");
          toast('Erro','Ocorreu um problema ao carregar os dados.',icon.error)
          console.error(ex.message)
        })
        .getAnos();
    }
   
    function getAllProgramas(selectedAno) {
      $.LoadingOverlay("show")
      google.script.run
        .withSuccessHandler((lista) => {
          try{
            const select = $("#selectPrograma");
            select.empty(); // clear existing options
            select.append($("<option>").text('Programa').prop('readonly', true).prop('hidden', true).prop('selected', true).val(''));
            lista.forEach((opt) => {
              const el = $("<option>").text(opt).val(opt);
              select.append(el);
            });
            if(lista.length==1){
              $("#selectPrograma").val(lista[0])
              getAllTurmas($("#selectAno").val(), $("#selectPrograma").val());
            }
            select.change(() => {
              const selectedPrograma = select.val();
              getAllTurmas(selectedAno, selectedPrograma);
            });
          }
          catch(ex){
            toast('Erro','Ocorreu um problema ao carregar os dados.',icon.error)
            console.error(ex)
          }
          finally{
            $.LoadingOverlay("hide")
          }
      })
      .withFailureHandler((ex)=>{
        $.LoadingOverlay("hide");
        toast('Erro','Ocorreu um problema ao carregar os dados.',icon.error)
        console.error(ex.message)
      })
      .getProgramas(selectedAno);
    }

    function getAllTurmas(selectedAno, selectedPrograma) {
      $.LoadingOverlay("show")
      google.script.run
        .withSuccessHandler((lista) => {
        try{
          const select = $("#selectTurma");
          select.empty();
          select.append($("<option>").text('Turma').prop('readonly', true).prop('hidden', true).prop('selected', true).val(''));
          lista.forEach((opt) => {
            const el = $("<option>").text(opt).val(opt);
            select.append(el);
          });
          if(lista.length==1){
              $("#selectTurma").val(lista[0])
          }
          select.change(() => {
            const selectedTurma = select.val();
          });
        }
        catch(ex){
          toast('Erro','Ocorreu um problema ao carregar os dados.',icon.error)
          console.error(ex)
        }
        finally{
          $.LoadingOverlay("hide");
        }
      })
      .withFailureHandler((ex)=>{
        $.LoadingOverlay("hide");
        toast('Erro','Ocorreu um problema ao carregar os dados.',icon.error)
        console.error(ex.message)
      })
      .getTurmas(selectedAno, selectedPrograma);
    }

    $(document).ready(() => {
      getAllAnos();
    });
  </script>

</body>

</html>