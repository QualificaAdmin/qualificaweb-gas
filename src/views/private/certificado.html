<style>
  :root {
    --tw-font-size: 1rem;
    --tw-toggle-size: 2rem;
    --tw-border-width: 0.1rem;
    --tw-toggle-margin: calc(var(--tw-toggle-size) / 6);
  }

  .tw-toggle {
    display: inline-block;
    /*padding: calc(var(--tw-toggle-size) / 12) calc(var(--tw-toggle-size) / 8);*/
    border-radius: 20px;
    position: relative;
    border: calc(var(--tw-border-width)) solid #95A5A6;
  }

  .tw-toggle label {
    text-align: center;
    font-family: sans-serif;
    display: inline-block;
    color: #95A5A6;
    position: relative;
    z-index: 2;
    margin: 0;
    text-align: center;
    padding: calc(var(--tw-font-size) / 7) calc(var(--tw-font-size) / 3.5);
    font-size: var(--tw-font-size);
  }

  .tw-toggle input {
    position: absolute;
    z-index: 3;
    opacity: 0;
    cursor: pointer;
    width: calc(var(--tw-toggle-size) * 0.7);
    height: calc(var(--tw-toggle-size) * 0.7);
  }

  .tw-toggle span {
    height: calc(var(--tw-toggle-size) /1.7);
    width: calc(var(--tw-toggle-size) / 1.7);
    line-height: calc(var(--tw-toggle-size) / 1.05);
    border-radius: 50%;
    background: #fff;
    display: block;
    position: absolute;
    left: calc(var(--tw-toggle-margin) * 7);
    top: calc(var(--tw-toggle-margin) / 1.5);
    transition: all 0.3s ease-in-out;
  }

  .tw-toggle input[value="F"]:checked~span {
    background: #e74c3c;
    left: calc(var(--tw-toggle-margin) / 2);
    color: #fff;
  }

  .tw-toggle input[value="P"]:checked~span {
    background: #27ae60;
    left: calc(var(--tw-toggle-margin) * 7.5);
  }

  .tw-toggle input[value=""]:checked~span {
    background: #95A5A6;
    left: calc(var(--tw-toggle-margin) * 3.6);
  }

  .tw-toggle input[value="F"]:checked+label,
  .tw-toggle input[value="P"]:checked+label {
    color: #fff;
  }

  .tw-toggle input[value=""]:checked+label {
    color: #fff;
  }

  .fa-circle {
    opacity: 0;
  }
</style>
<div class="container">
  <div class="card mt-3">
    <div class="card-header">
      <h3>Certificado</h3>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col">
          <label for="selectAno">Ano:</label>
          <select class="custom-select custom-select-md mb-3" id="selectAno">
            <option selected value="">Selecione</option>
          </select>
        </div>
        <div class="col">
          <label for="selectPrograma">Programa:</label>
          <select class="custom-select custom-select-md mb-3" id="selectPrograma">
            <option selected value="">Selecione</option>
          </select>
        </div>
        <div class="col">
          <label for="selectTurma">Turma:</label>
          <select class="custom-select custom-select-md mb-3" id="selectTurma">
            <option selected value="">Selecione</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-header mt-3">
      <button class="btn btn-primary" onclick="salvarFrequencia()" type="submit">
          <i class="fa fa-save"></i> Salvar
        </button>
    </div>
    <div class="card-body mt-3">
      <table class="table" id="tabela"></table>
    </div>
  </div>
</div>



<script>
  function getAllAnos() {
    google.script.run
    .withSuccessHandler((lista) => {
      const select = $("#selectAno");
      select.empty(); 
      select.append($("<option>").text('Selecione').val(''));
      lista.forEach((opt) => {
        const el = $("<option>").text(opt).val(opt);
        select.append(el);
      });
      select.change(() => {
        $.LoadingOverlay("show")
        const selectedAno = select.val()
        getAllProgramas(selectedAno)
      });
      $.LoadingOverlay("hide")
    })
    .withFailureHandler((ex)=>{
      console.log(ex)
    })
    .getAnos();
  }

  function getAllProgramas(selectedAno) {
    google.script.run.withSuccessHandler((lista) => {
      const select = $("#selectPrograma");
      select.empty(); // clear existing options
      select.append($("<option>").text('Selecione').val(''));
      lista.forEach((opt) => {
        const el = $("<option>").text(opt).val(opt);
        select.append(el);
      });
      select.change(() => {
        $.LoadingOverlay("show");
        const selectedPrograma = select.val();
        getAllTurmas(selectedAno, selectedPrograma);
      });
      $.LoadingOverlay("hide");
    }).getProgramas(selectedAno);
  }

  function getAllTurmas(selectedAno, selectedPrograma) {
    google.script.run.withSuccessHandler((lista) => {
      const select = $("#selectTurma");
      select.empty(); 
      select.append($("<option>").text('Selecione').val(''));
      lista.forEach((opt) => {
        const el = $("<option>").text(opt).val(opt);
        select.append(el);
      });
      select.change(() => {
        $.LoadingOverlay("show");
        const selectedTurma = select.val();
        getFrequencia(selectedAno, selectedPrograma,selectedTurma);
      });
      $.LoadingOverlay("hide");
    }).getTurmas(selectedAno, selectedPrograma);
  }

  function getFrequencia(ano,programa,turma){
    google.script.run.withSuccessHandler((jsonData)=>{
      jsonData=JSON.parse(jsonData);
      const table = $('#tabela');

      const headerRow = $('<tr>');
      headerRow.append($('<th>').text('Nome').attr('scope', 'col'));
      
      for (const prop in jsonData[0]) { 
        if (prop !== 'nome') { 
          headerRow.append($('<th>').text(prop).attr('scope', 'col'));
        }
      }
      table.append($('<thead>').append(headerRow));
      
      const tbody = $('<tbody>');
      let cont=0;
      jsonData.forEach((data)=>{
        const dataRow = $('<tr>', { 
          html: $('<td>').text(data.nome)
        });
        for (const prop in data) {
          if (prop !== 'nome') {
            cont++;
            const toggleDiv = $('<div>').addClass('tw-toggle');
            const labels = ['F', '', 'P'];
            labels.forEach(label => {
            const input = $('<input>').attr({
              type: 'radio',
              name: prop+cont,
              value: label
            }).prop('checked', data[prop] == label);
            const iconClass = label=='P'?'fa-check':(label=='F'?'fa-times':'fa-2xs fa-circle');
            const toggleLabel = $('<label>').addClass('toggle toggle-yes')
              .append($('<i>').addClass(`fa ${iconClass}`));
            toggleDiv.append(input, toggleLabel,$('<span>'));
          });
          dataRow.append($('<td>').append(toggleDiv));
        }
      }
      tbody.append(dataRow);
      });
      table.append(tbody);
      $.LoadingOverlay("hide");
    }).getFrequencia(ano,programa,turma);
  }
  function salvarFrequencia(){
    $.LoadingOverlay("show");
    var json = [];
    $('#tabela tbody tr').each(function(i, row) {
      var rowData = {};
      $(row).find('td:not(:first)').each(function(j, cell) {
        var date = $('#tabela thead tr th').eq(j+1).text();
        var value = $(cell).find('input:checked').val();
        rowData[date] = value;
      });
      json.push({ "Nome": $(row).find('td:first').text(), "Data": rowData });
    });

    google.script.run
      .withFailureHandler(()=>{
        alert('Ocorreu um problema ao salvar!')
        $.LoadingOverlay("hide");
      })
      .withSuccessHandler(()=>{
        alert('Dados salvos com sucesso!')
        $.LoadingOverlay("hide");
      })
      .setFrequencia( $("#selectAno").val(), $("#selectPrograma").val(), $("#selectTurma").val(),JSON.stringify(json));
  }
  $(document).ready(() => {
    $.LoadingOverlay("show");
    getAllAnos();
  });
</script>